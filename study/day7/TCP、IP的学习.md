# TCP/IP的学习 #
## **三次握手** ##
### TCP提供面向有连接的通信传输。面向有连接是指在数据通信开始之前两端就做好准备工作。 ###
### 三次握手指建立一个TCP连接需要客户端和服务端共发送3个包确定连接建立。在socket编程中，这个过程由客户端执行connect触发。 ###

## 三次握手流程 ##
### 第一次握手，客户端标志位SYN为1，随机产生一个值seq=J，并将该数据包发给服务端，客户端进入SYN_SENT状态，等待服务器确认。 ###
### 第二次握手，服务器端收到数据包后由标志位SYN=1知道客户端请求建立连接；服务器端将标志位SYN和ACK都置为1，ack=J+1，随机产生一个值seq=K，并将该数据包发给客户端以确认连接要求，服务器端进入SYN_RCVD状态。 ###
### 第三次握手，客户端收到确认后，检查ack是否为J+1，ACK是否为1，如果正确将标志位ACK置为1，ack=K+1并将数据包传给服务端，服务器检查ack是否为K+1，ACK是否为1，如果正确建立连接成功，客户端和服务器都进入ESTABLISHED状态。完成三次握手，随后客户端与服务器端之间可以开始传输数据。 ###

## **四次挥手** ##
### 四次挥手即终止TCP连接，指断开一个连接，客户端和服务端共发4个包以确认连接断开。在socket编程中，这个过程由服务端或客户端任一方执行close触发。 ###
### 由于TCP连接是全双工的，因此每个方向都要单独进行关闭，这个原则是当任一方完成数据发送任务后发送一个FIN终止这个方向的连接，收到一个FIN代表着这一个方向没有数据流动，即不会再收到数据，但是在这个TCP连接上仍然能发送数据直到这个方向上也发生了FIN，首先进行关闭的一方执行主动关闭，另一方执行被动关闭。 ###

## 四次挥手流程 ##
### 中断连接端可以是服务器端也可以是客户端。 ###
### 第一次挥手：客户端发送一个FIN=M，用来关闭客户端到服务器端数据的传送，客户端进入FIN_WAIT_1的状态。意思是说“客户端没有数据发给你了”，但如果服务器端还有数据没有发送完成，不用急着关闭连接，可以继续发送数据。 ###
### 第二次挥手：服务器端收到FIN后，先发送ack=M+1，告诉服务端，你的请求我收到了，但是我还没准备好，请你继续等待我的信息。客户端进入FIN_WAIT_2状态，继续等待服务器端的FIN报文。 ###
### 第三次挥手，服务器端确定数据已发送完成，向客户端发送FIN=N报文。告诉客户端，我的数据发送完成，准备好关闭连接了。服务器端进入LAST_ACK状态。 ###
### 第四次挥手：客户端收到FIN=N报文后，知道可以关闭连接了，但它不相信网络，怕服务器端不知道服务端要关闭，发送ack=N+1后进入TIME_WAIT状态，如果服务端没有收到ACK则重传。服务器端收到ACK后知道可以断开连接了，客户端等待MSL后没有收到回复证明服务器端正常关闭，客户端也可以关闭连接了，最终完成四次握手。 ###

## 同时挥手 ##
### 通过序列号与确认应答提高可靠性 ###
TCP中，当发送端的数据到达接收主机后，接收端主机会返回一个已收到信息的通知，这个信息叫做确认应答（ACK）。当发送端将数据发出后会等待对端的确认应答，如果有确认应答，说明数据已经成功到达对端。反之，数据丢失可能性很大，也有可能是接收主机无法发送数据确认应答。

在一定时间没有等待到确认应答，发送端可以认为数据已经丢失，并对数据进行重发处理，因为这个机制，所以即使产生了丢包，仍然可以保证数据可以到达对端实现可靠传输。

未收到确认应答不代表数据一定丢失，也有可能是数据收到后对方的确认应答回复在中途丢失了，这种情况也会导致发送误以为数据没有达到目的地而重发数据。

对于目标主机来说反复收到相同数据是不可取的，为了对上层应用提供可靠的传输，目标主机必须放弃重复的数据包，所以我们引入了序列号。


## 序列号 ##
#### 序列号是按照顺序给发送数据的每个字节（8位字节）都标上号码的编号。接收端查询接收数据TCP首部中的序列号和数据长度，将自己下一步应该接收的序列号作为确定应答送回去。通过序列号和确认应答号，TCP能识别是否已经接收数据，又判断是否需要接收，从而实现可靠传输。 ####


### 重发超时的确定 ###
#### 重发超时是指在重发数据之前，等待确认应答到来的那个特定时间间隔。 ####

#### TCP要求不管处于何种网络环境都要提供高性能通信，并且无论网络拥堵情况发送何种变化，都必须保证这一特性。它在每次发包时都会计算往返时间及其偏差，这个往返时间和偏差相加，重发超时的时间比这个总和稍大一点。 ####

#### 在BSD的Unix和Windows系统中，超时都以0.5s为单位进行控制，因此重发超时都是0.56s的整数倍，最初的重发超时默认值一般为6s左右。 ####

#### 数据也不会无限、反复的重发，达到一定重发次数后，如果没有任何的确认应答返回，则会判断网络或者对端主机发生了异常，强制关闭连接，并通知应用程序连接异常强制关闭通信。 ####

### 以段位单位发送数据 ###

#### 建立TCP连接的同时，确定发送数据包的单位——“最大信息长度（MSS）”。最理想情况，最大信息长度正好是IP中不会被分片处理的最大数据长度。 ####

#### TCP在传送大量数据时。以MSS的大小将数据分割传送，进行重发也是以MSS为单位。 ####

#### 第三次握手的时候，两端主机之间的MSS由计算得出，两端主机在发出建立连接的要求时，会在TCP首部写入MSS选项，告诉对方自己适应的MSS大小，然后取小值使用。 ####

