# TCP\IP的学习 #
## 利用窗口控制提高速度 ##
TCP以一个段为单位，每发送一个段就进行一次确认应答处理，包的往返时间越长通信性能越低。

为解决包的往返时间越长通信性能越差这个问题，TCP引入了窗口概念，确认应答不是以分段为单位确认，而是以更大的单位确定，转发时间大大减少。发送端主机发送一个段后不用一直等待确认应答而是继续发送。

窗口控制，窗口大小是指无需等待确认应答可以继续发送的数据的最大值，这个机制的实现使用大量的缓冲区，同时对多个段进行同时确认应答功能。

----
### 滑动窗口 ###
----
窗口内的数据即使没有收到确认应答也可以被发送出去，但在整个窗口确认应答没有达到之前，如果部分数据出现丢包，发送端仍要将对丢包的数据进行重传处理。发送端主机要设置缓存区保留这些待被重传的数据直到他们的确认应答。

在滑动窗口以外部分包括未发送的数据和已经确认对端已收到数据。当数据发出后如果按时收到确认应答可以不用重发，此时数据可以从缓存区清除。

收到确认应答的情况下，将窗口滑动到确认应答中序列号的位置，这样可以顺序将多个段同时发送提高通信性能，这种机制也叫滑动窗口控制机制。

## 窗口控制的重发控制 ##
使用窗口控制中，出现丢包一般分为两种：
1、确认应答未能返回的情况，这种情况，数据达到对端了，不需要重发。

2、某个报文段丢失的情况。接收主机如果收到一个该收到的序列号以外的数据时，会针对当前为止收到的数据返回确认应答。当窗口较大，且出现报文丢失的情况下，同一个序列号的确认应答会被不断重复返回。发送端主机如果连续三次收到同一个确认应答，就会将对应数据进行重发。这种机制也叫做高速重发控制。

## 网络层的IP协议 ##
IP（IPv4、IPv6）相当于OSI参考模型中的第三层——网络层。网络层的主要作用是“实现终端节点之间的通信”。

网络的下一层——数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递。网络层可以跨越不同的数据链路，即使不同的数据链路也可以实现两端节点之间的数据包传输。

**IP分为三大作用模块，IP寻址、路由（最终节点为止的转发）以及IP分包与组包**



## IP地址 ##
### IP地址概述 ###
数据链路中MAC地址用来识别同一个链路中不同计算机的一个识别码。

网络层的地址信息叫做IP地址。IP地址用于识别进行通信的目标地址（这个目标地址在网络中所有主机之中）。

不管主机与哪种数据链路连接，IP地址形式都不变。

IP地址（IPV4地址）由32位正整数表示。IP地址在计算机内部以二进制方式被处理。我们将IP地址以每八位分成一组，分为四组，每组以“.”分隔开，然后再把每组数转换为十进制数。

### IP地址由网络和主机两部分标识组成。 ###
网络标识必须保证相互连接的每个段地址不重复。相同段内相连的主机必须有相同的网络地址。IP地址的主机标识不允许在同一个网段重复出现，可以通过配置网络地址和主机地址，在相互连接的整个网络中保证每天主机的IP都不会重叠，使得IP地址具有唯一性。

### IP地址的主机标识 ###
IP包被转发到某个路由器的时候，利用目标IP地址的网络标识进行路由。即使不知道主机标识，只要知道网络标识就可以知道是不是这个网段内的主机。

## IP网络标识 ##

### IP地址的分类 ###
**IP地址分为四个级别，A类、B类、C类、D类。IP地址根据自己的第一位到第四位的比特列对网络标识和主机标识进行区分。**

** A类IP地址是以首位为“0”开头的地址。第一位到第八位是他的网络标识。0.0.0.0~127.0.0.0是A类网络地址，后二十四位是主机标识。**

** B类地址是前两位是“10”的地址。第一位到第十六位是他的网络标识。128.0.0.0~191.255.0.0是B类网络地址，后十六位是网络标识。**

** C类地址是前三位是“110”的地址。第一位到第二十四位是他的网络标识。192.0.0.0~223.255.255.0是C类网络地址。C类地址的后八位是主机标识。**

** D类地址前四位是“1110”的地址。第一位到第三十二位是他的网络标识。224.0.0.0~239.255.255.255是D类网络地址。D类地址没有主机标识，多用于广播。**

### 广播地址 ###

广播地址用于在同一个链路中互相连接的主机之间发送数据包。将IP地址中主机地址部分全部设置为1就成为了广播地址。

### IP多播 ###
多播用于把包发送给特定组内的全部主机。
相比广播，多播可以穿透路由器，又可以实现只给必要的组发送数据包。
IP多播使用D类地址。从首位到第四位是“1110”，可以认为多播地址，剩下的28位为多播的组编号。

### 子网掩码 ###

现在一个IP地址的网络标识和主机标识已不受限该地址的类别。
子网掩码的识别码通过子网网络地址细分出比A类、B类、C类更小粒度的网络。这种方式是将原来A类、B类、C类等分类中的主机地址部分用作子网地址，将原网络分为多个物理网络的一个机制。

子网掩码用二进制表示的话也是一个32位的数字，它对应IP地址网络标识部分的位全部为“1”，对应IP地址主机标识部分全部为“0”。因此IP地址可以不用受限于自己的类别，而是可以用子网掩码自由定位自己的网络标识长度。子网掩码必须是IP地址的首位开始连续的“1”。

对于子网掩码，目前有两种表达方式：
第一种：IP和子网掩码分别用两行来表示。
第二种：在每个IP地址后面追加网络地址位数用/隔开。

## 路由 ##

发送数据包时使用的地址是网络层地址，即IP地址。仅有IP地址不足以实现将数据包发送到对端目标地址，在数据发送过程中还需要“指明路由器或主机”的信息，保存这种信息的就是路由控制表。

路由控制表的形成方式有两个：
1、由管理员手动设置。静态路由控制。
2、路由器与其他路由器相互交换信息时自动刷新。动态路由控制。

IP协议始终认为路由表时正确的。IP没有定义制作路由控制表的协议。IP没有制作路由控制表的机制。路由控制表由路由协议制作而成。


### IP地址与路由控制 ###
IP地址的网络地址部分用于进行路由控制。

路由控制表中记录网络地址与下一步应该发送到路由器的地址。

发送IP包时，首先要确认IP包首部中的目标地址，再从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将IP包转发给下一个路由器。如果路由器控制表存在多条相同的网络地址记录，选择一个最吻合的网络地址。

## 路由控制表和IP包发送 ##

### IP分包和组包 ###
每种数据链路的最大传输单元（MTU）都不同。因为每个不同类型的数据链路使用目的不同，使用目的不同，可承载的MTU也不尽相同。

任何一台主机都要对IP分片进行处理，分片往往在网络上遇到比较大的报文无法一下子发出去才会处理。

经过分片的IP数据报在被重组的时候，由目标主机进行。路由器虽然分片但不进行重组操作。

### 路径MTU的实现 ###

分片机制也有缺点，比如给路由器增加工作，只要允许不希望路由器进行IP分片处理。

为了应对分片机制不足，“路径MTU发现”技术产生。路径MTU指的是，发送端主机到接收端主机之间不需要分片，使用最大MTU大小，即路径中所有数据链路都是最小MTU。

进行路径MTU发现，可以避免中途路由器上进行分片处理，在TCP中发送更大的包。

### IPV6 ###
IPV6是为了解决IPV4地址耗尽而标准化的网络协议。IPV4的地址长度为4个8位字节，32比特。
IPV6的地址长度为8个16位字节，128比特。

### IPV6的特点 ###
IP得知的扩大与路由控制表的聚合。

性能提升。简化首部结构，减轻路由器负担，路由器不再做分片处理，包首长度采用固定值（40字节），不采用首部验证码。

支持即插即用功能，没有DHCP服务器也可以实现自动分配IP地址。DHCP是一个局域网网络协议，全称是动态主机配置协议，指的是服务器控制一段IP地址范围，客户机登录服务器就可以自动获取服务器分配的IP地址和子网掩码。

采用认证和加密功能，因对伪造IP地址的网络安全功能以及防止线路窃听功能。

多播、Mobile IP成为扩展功能。

### IPV6中IP地址的标记方法 ###

128比特IP地址以每16比特为一组，每组用“：”分开进行标记。

如果出现连续的0可以用“：：”隔开，来省略这些0，一个IP地址只允许出现一次两个连续的冒号。

### IPv6地址的结构 ###
IPv6类似IPv4，通过IP地址的前几位标识IP地址的种类。

互联网通信中，使用一种全局的单播地址，它是互联网中唯一的一个地址，不需要正式分配IP地址。

### 全局单播地址 ###
全局单播地址是指世界上唯一的一个地址。这个地址时互联网通信以及各个域内部通信中最常用的一个IPv6
地址。

### 链路本地单播地址 ###
唯一本地地址
是不进行互联网通信所用的地址，虽然唯一本地地址不会与互联网连接，但是也会随机生成一个唯一的全局ID。
L通常被置为1。
全局ID值随机决定。
子网ID是该域子网地址。
接口ID。

### IPv6分段处理 ###

IPv6的分片处理旨在作为起点的发送端主机上进行，路由器不参与分片。

IPv6最小MTU为1280字节，因此嵌入式系统对资源限制设备不需要路径MTU发现，发送包的时候直接以1280为单位分片发出即可。

## IP协议相关技术 ##
ip旨在让目标主机收到数据包，但仅有IP是无法实现通信的，必须还能够解析主机名称和MAC地址的功能，以及数据包在发送过程中异常情况处理的功能。

### DNS ###
用户在TCP/IP通信的时候也不使用IP地址，因为有了DNS（domain name system）功能的支持。DNS可以自动将字符串转换为具体的IP地址。

DNS不仅适用于IPv4、也适用于IPv6。

### ARP ###
只要确定IP地址，就可以向这个目标地址发送IP数据报，但底层数据链路层，实际通信需要知道每个IP地址对应的MAC地址。

ARP是一种解决地址问题的协议，以目标IP地址为线索，用来定位下一次应该接收数据分包的网络设备对应的MAC地址。ARP只适用于IPv4，IPv6用ICMPv6替代ARP完成发送邻居探索信息。

RARP是将ARP反过来，从MAC地址定位IP地址的一种协议。

### ICMP ###
ICMP主要功能包括：确认IP包是否送达目标地址，通知发送过程中IP包被废弃原因，改善网络设置。

IPv4的ICMP作为一个辅助支持IPv4。IPv4时期，没有ICMP也可以实现IP通信，在IPv6中，ICMP功能放大，没有ICMP，IPv6无法正常通信。

### DHCP ###
DHCP协议可以实现自动设置IP地址、统一管理IP地址分配。有了DHCP，计算机连接到网络就可以进行TCP/IP通信。正是有了DHCP才可以即插即用。

DHCP在IPv4和IPv6都可以使用。

### NAT ###
NAT是用于本地网络使用私有地址，在连接互联网使用全局IP地址的技术。

除了能转换IP外，还有可以转换TCP、UDP端口号的NAPT技术，由此可以实现一个全局IP与多个主机进行通信。

NAT实际是为IPv4开发的技术，IPv6为了提高网络安全也会使用NAt，在IPv4和IPv6之间相互通信使用NAT-PT。

### IP隧道 ###
夹着IPv4网络的两个IPv6网络。
想要上述情况的两个IPv6网络可以通信，必须采用IP隧道功能。

IP隧道可以将网络A发过来的IPv6包统合为一个数据，再给这个包添加一个IPv4首部之后转发给网络C。

一般来说，在IP首部后面是TCP或UDP首部，但现在出现了IP首部后面还是IP首部或IP首部后面是IPv6首部，在网络层首部后加网络层首部的通信方法叫“IP隧道”。
